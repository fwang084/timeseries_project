---
title: "final_project"
author: "Frank Wang"
date: "4/18/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(astsa)
library(forecast)
```

```{r}
# data = read.csv("~/Desktop/stat153/timeseries_project/Alcohol_Sales.csv")
# data = read.csv("C:/Users/willi/Documents/GitHub/timeseries_project/Alcohol_Sales.csv")
data = read.csv("C:/Users/selen/OneDrive/Documents/GitHub/timeseries_project/Alcohol_Sales.csv")
ts.plot(data, xlab = 'Months Since Jan 1992', ylab = 'US Alcohol Sales (Millions of Dollars)', main = 'Time Series of US Alcohol Sales')
```

```{r}
log_data = log(data$S4248SM144NCEN)
ts.plot(log_data, xlab = 'Months Since Jan 1992', ylab = 'Log Alcohol Sales (Millions of Dollars)', main = 'Time Series of Log US Alcohol Sales')
```

```{r}
# differenced data 
diff_data = diff(diff(log_data, 12, 1), 3, 1)
plot(diff_data, type = 'l', xlab = 'Months Since Jan 1992', ylab = 'Difference', main = 'Lag 3 Difference of Lag 12 Differenced Log Data')
acf2(diff_data)
```

```{r}
# arma 1: ARMA(6)
auto.arima(diff_data)
sarima(diff_data, 6, 0, 0)

corrs = ARMAacf(ar = c(-0.0502, 0.0994, -0.3477, -0.0539, 0.2128, -0.2454), lag.max = 28)
par.corrs = ARMAacf(ar = c(-0.0502, 0.0994, -0.3477, -0.0539, 0.2128, -0.2454), lag.max = 28, pacf = TRUE)

plot(x = 1:28, y = corrs[2:29], type = "h", xlab = "Lag k", ylab = "Autocorrelation")
abline(h = 0)
plot(x = 1:28, y = par.corrs, type = "h", xlab = "Lag k", ylab = "Partial Autocorrelation")
abline(h = 0)
```
```{r}
# arma 2: arma(5, 1)
sarima(diff_data, 5, 0, 1)

corrs = ARMAacf(ar = c(-0.7059, 0.0481, -0.2426, -0.2349, 0.2032), ma = 0.6887, lag.max = 28)
par.corrs = ARMAacf(ar = c(-0.7059, 0.0481, -0.2426, -0.2349, 0.2032), ma = 0.6887, lag.max = 28, pacf = TRUE)

plot(x = 1:28, y = corrs[2:29], type = "h", xlab = "Lag k", ylab = "Autocorrelation")
abline(h = 0)
plot(x = 1:28, y = par.corrs, type = "h", xlab = "Lag k", ylab = "Partial Autocorrelation")
abline(h = 0)
```

```{r}
n = length(data$S4248SM144NCEN)
pgram = abs(fft((log_data)[2:n]))^2/n
plot(pgram[1:n], type = "h")
pgram 

t = 1:n



frequency = 12
cosX = matrix(NA,ncol=frequency / 2,nrow=length(log_data))
sinX = matrix(NA,ncol=frequency / 2 - 1,nrow=length(log_data))
for(i in 1:(frequency/2)){
cosX[,i] = cos(2*pi*t*i/frequency)
if(i<(frequency / 2)){sinX[,i] = sin(2*pi*t*i/frequency)}
}

tt = t^2
ttt = t^3
tttt = t^4
#lin.mod = lm(log_data ~ 1 + t + cosX + sinX)

lin.mod = lm(log_data ~ t + tt + ttt + tttt + cosX + sinX +  factor( t %% 12 ) )

plot.ts(t, log_data, type = 'l', main="Log of Alcohol Sales with Fitted Parametric Model", xlab = 'Months Since Jan 1992',ylab="Log(Alcohol Sales)")
lines(t, lin.mod$fitted, col = '2')
```

```{r}
plot.ts(lin.mod$residual, ylab = "residual", main="Residuals of a seasonal parametric fit for the Log of Alochol Sales")
```
```{r}
auto.arima(lin.mod$residuals)
acf(lin.mod$residuals)

pacf(lin.mod$residuals)
```
```{r}
t = 1:n
mos = factor(t %% 12)
v2 = cos(2*pi*1*t/12)
v3 = sin(2*pi*1*t/12)
v4 = cos(2*pi*2*t/12)
v5 = sin(2*pi*2*t/12)
v6 = cos(2*pi*3*t/12)
v7 = sin(2*pi*3*t/12)
v8 = cos(2*pi*4*t/12)
v9 = sin(2*pi*4*t/12)
v10 = cos(2*pi*5*t/12)
v11 = sin(2*pi*5*t/12)
v12 = cos(2*pi*6*t/12)
lin.mod2 = lm(log_data ~ poly(t, 4) + v2 + v3 + v4 + v5 + v6 + v7 + v8 + v9 + v10 + v11 + v12)

plot.ts(t, log_data, type = 'l', main="Log of Alcohol Sales with Fitted Parametric Model", xlab = 'Months Since Jan 1992',ylab="Log(Alcohol Sales)")
lines(t, lin.mod2$fitted, col = '2')

plot.ts(lin.mod2$residual, ylab = "residual", main="Residuals of a seasonal parametric fit for the Log of Alochol Sales")
```

```{r}
# cross validation

forecasts = list(
  m1 = c(),
  m2 = c(),
  m3 = c(),
  m4 = c()
)

errors = list(
  m1 = c(),
  m2 = c(),
  m3 = c(),
  m4 = c()
)

for (i in 1985:1995) {
  m = 12
  n = (i-1970)*12
  
  # handle special case of 1995 which has only 8 data points
  if (i == 1995){
    m = 8
    n = n - 4
  }
  
  # training time range
  t = 1:n
  tt = t^2
  ttt = t^3
  
  # testing time range
  t2 = (n+1):(n+m)
  
  mos = factor(t %% 12)
  
  # fit models
  m1 = sarima(v_t[1:n], 2, 1, 3, 0, 1, 1, 12, details = FALSE)
  m2 = sarima(v_t[1:n], 1, 1, 1, 0, 1, 1, 12, details = FALSE)
  m3 = sarima(v_t[1:n], 2, 1, 2, 0, 1, 1, 12, details = FALSE)
  m4 = lm(v_t[1:n] ~ -1 + t + tt + ttt + mos)
  
  # get SARIMA model parameters
  coeff1 = m1$ttable[1:6]
  coeff2 = m2$ttable[1:3]
  coeff3 = m3$ttable[1:5]
  
  # forecast for SARIMA models
  f1 = sarima.for(v_t[1:n], n.ahead = m, 2, 1, 3, 0, 1, 1, 12, fixed = coeff1, plot = FALSE)
  f2 = sarima.for(v_t[1:n], n.ahead = m, 1, 1, 1, 0, 1, 1, 12, fixed = coeff2, plot = FALSE)
  f3 = sarima.for(v_t[1:n], n.ahead = m, 2, 1, 2, 0, 1, 1, 12, fixed = coeff3, plot = FALSE)
  
  # get predictions for years, undoing log transformation
  pred1 = exp(f1$pred)
  pred2 = exp(f2$pred)
  pred3 = exp(f3$pred)
  
  # get parameters for parametric model
  b = unname(m4$coefficients)
  
  # get parametric predictions, undoing log transformation (note: reordered coefficients to ensure that the indicator for dec is at the end)
  pred4 = exp(c(b[5:15], b[4])[1:m] + b[1]*t2 + b[2]*t2^2 + b[3]*t2^3)
  
  # actual values
  actual = gas_data[(n+1):(n+m)] 
  
  # compute sses
  sse1 = sum((actual - pred1)^2)
  sse2 = sum((actual - pred2)^2)
  sse3 = sum((actual - pred3)^2)
  sse4 = sum((actual - pred4)^2)
  
  # append forecasts/errors to appropriate list
  forecasts$m1 = c(forecasts$m1, pred1)
  forecasts$m2 = c(forecasts$m2, pred2)
  forecasts$m3 = c(forecasts$m3, pred3)
  forecasts$m4 = c(forecasts$m4, pred4)
  errors$m1 = c(errors$m1, sse1)
  errors$m2 = c(errors$m2, sse2)
  errors$m3 = c(errors$m3, sse3)
  errors$m4 = c(errors$m4, sse4)
}
```

 
